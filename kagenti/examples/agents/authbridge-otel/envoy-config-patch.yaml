# Envoy config patch for AuthBridge OTEL tracing
#
# This shows the changes needed to the envoy-config ConfigMap in
# charts/kagenti/templates/agent-namespaces.yaml to enable body buffering
# for the ext_proc filter, which is required for A2A JSON-RPC body parsing.
#
# Current config: request_body_mode: NONE, response_body_mode: NONE (SKIP on responses)
# New config: request_body_mode: BUFFERED, response_body_mode: BUFFERED
#
# Apply this to the ext_proc filter in both outbound and inbound listeners.

# Changes to the outbound_listener ext_proc filter:
# (charts/kagenti/templates/agent-namespaces.yaml, envoy-config ConfigMap)
#
# BEFORE:
#   processing_mode:
#     request_header_mode: SEND
#     response_header_mode: SKIP
#     request_body_mode: NONE
#     response_body_mode: NONE
#
# AFTER:
#   processing_mode:
#     request_header_mode: SEND
#     response_header_mode: SEND        # Changed: process response headers
#     request_body_mode: NONE           # Outbound: no body parsing needed
#     response_body_mode: NONE          # Outbound: no body parsing needed

# Changes to the inbound_listener ext_proc filter:
# (This listener needs body buffering for A2A request/response parsing)
#
# BEFORE:
#   (no processing_mode specified, defaults)
#
# AFTER:
#   processing_mode:
#     request_header_mode: SEND
#     response_header_mode: SEND
#     request_body_mode: BUFFERED       # NEW: buffer A2A JSON-RPC request body
#     response_body_mode: BUFFERED      # NEW: buffer A2A JSON-RPC response body

# Example inbound listener with body buffering:
static_resources:
  listeners:
    - name: inbound_listener
      address:
        socket_address:
          protocol: TCP
          address: 0.0.0.0
          port_value: 15124
      filter_chains:
        - filters:
            - name: envoy.filters.network.http_connection_manager
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                stat_prefix: inbound
                codec_type: AUTO
                route_config:
                  name: local_route
                  virtual_hosts:
                    - name: local_app
                      domains: ["*"]
                      routes:
                        - match:
                            prefix: "/"
                          route:
                            cluster: local_app
                      # Add direction header for ext_proc routing
                      request_headers_to_add:
                        - header:
                            key: "x-authbridge-direction"
                            value: "inbound"
                          append_action: OVERWRITE_IF_EXISTS_OR_ADD
                http_filters:
                  - name: envoy.filters.http.ext_proc
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.ext_proc.v3.ExternalProcessor
                      grpc_service:
                        envoy_grpc:
                          cluster_name: ext_proc_cluster
                        timeout: 30s
                      processing_mode:
                        request_header_mode: SEND
                        response_header_mode: SEND
                        # OTEL tracing requires body access for:
                        # - Request: BUFFERED to parse A2A JSON-RPC for user input, context_id
                        # - Response: STREAMED to accumulate SSE chunks for agent output
                        request_body_mode: BUFFERED
                        response_body_mode: STREAMED
                  - name: envoy.filters.http.router
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

apiVersion: kagenti.operator.dev/v1alpha1
kind: Component
metadata:
  labels:
    app.kubernetes.io/created-by: streamlit-ui
    app.kubernetes.io/name: kagenti-operator
    kagenti.io/framework: LangGraph
    kagenti.io/protocol: a2a
    kagenti.io/type: agent
  name: weather-service
  namespace: team1
spec:
  agent:
    build:
      mode: dev-local
      pipeline:
        namespace: ""
        parameters:
        - name: SOURCE_REPO_SECRET
          value: github-token-secret
        - name: repo-url
          value: github.com/Ladas/agent-examples
        - name: revision
          value: phoenix-autoinstrumentation
        - name: subfolder-path
          value: a2a/weather_service
        - name: image
          value: registry.cr-system.svc.cluster.local:5000/weather-service:v0.0.1
        steps:
        - configMap: github-clone-step
          enabled: true
          name: github-clone
        - configMap: check-subfolder-step
          enabled: true
          name: folder-verification
        - configMap: kaniko-docker-build-step-local
          enabled: true
          name: kaniko-build
  deployer:
    deployAfterBuild: true
    env:
    # Service Configuration
    - name: PORT
      value: "8000"
    - name: HOST
      value: "0.0.0.0"

    # OpenTelemetry Configuration
    - name: OTEL_EXPORTER_OTLP_ENDPOINT
      value: "http://otel-collector.kagenti-system.svc.cluster.local:8335"
    - name: OTEL_SERVICE_NAME
      value: "weather-service"
    - name: OTEL_EXPORTER_OTLP_PROTOCOL
      value: "grpc"
    - name: OTEL_EXPORTER_OTLP_INSECURE
      value: "true"

    # Phoenix Project Assignment
    - name: PHOENIX_PROJECT_NAME
      value: "team1-agents"

    # Deployment Environment
    - name: DEPLOYMENT_ENVIRONMENT
      value: "kind-local"

    # Resource Attributes
    - name: OTEL_RESOURCE_ATTRIBUTES
      value: "deployment.environment=kind-local"

    # Application Configuration
    - name: KEYCLOAK_URL
      value: "http://keycloak.keycloak.svc.cluster.local:8080"
    - name: UV_CACHE_DIR
      value: "/app/.cache/uv"

    # LLM Configuration
    - name: LLM_API_BASE
      value: "http://dockerhost:11434/v1"
    - name: LLM_API_KEY
      value: "dummy"
    - name: LLM_MODEL
      value: "qwen2.5:0.5b"

    # Secrets
    - name: GITHUB_SECRET_NAME
      value: "github-token-secret"
    kubernetes:
      containerPorts:
      - containerPort: 8000
        name: http
        protocol: TCP
      imageSpec:
        image: weather-service
        imagePullPolicy: Always
        imageRegistry: registry.cr-system.svc.cluster.local:5000
        imageTag: v0.0.1
      resources:
        limits:
          cpu: 500m
          memory: 1Gi
        requests:
          cpu: 100m
          memory: 256Mi
      servicePorts:
      - name: http
        port: 8000
        protocol: TCP
        targetPort: 8000
      volumeMounts:
      - mountPath: /app/.cache
        name: cache
      - mountPath: /.marvin
        name: marvin
      volumes:
      - emptyDir: {}
        name: cache
      - emptyDir: {}
        name: marvin
    name: weather-service
    namespace: team1
  description: Agent 'weather-service' built from UI.
  suspend: false